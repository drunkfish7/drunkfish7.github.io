<!DOCTYPE html>
<html lang="zh-CN">







<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<link rel="preconnect" href="//www.googletagmanager.com">
	<link rel="preconnect" href="//zz.bdstatic.com">
	<link rel="preconnect" href="//sp0.baidu.com">
	<link rel="preconnect" href="//www.google-analytics.com">
	<link rel="preconnect" href="//cdn1.lncld.net">
	<link rel="preconnect" href="//unpkg.com">
	<link rel="preconnect" href="//app-router.leancloud.cn">
	<link rel="preconnect" href="//9qpuwspm.api.lncld.net">
	<link rel="preconnect" href="//gravatar.loli.net">

	<title>Home Assistant 系列——DIY 篇（上） | 庄菲什</title>

	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
	<meta name="generator" content="hexo">
	<meta name="author" content="drunkfish">
	<meta name="description" content="">

	

	

	

	

	

	<meta property="og:site_name" content="庄菲什">
	<meta property="og:type" content="article">
	<meta property="og:title" content="Home Assistant 系列——DIY 篇（上） | 庄菲什">
	<meta property="og:description" content="">
	<meta property="og:url" content="http://yoursite.com/ha3/">

	
	<meta property="article:published_time" content="2020-02-15T00:02:00+08:00"/> 
	<meta property="article:author" content="drunkfish">
	<meta property="article:published_first" content="庄菲什, /ha3/" />
	

	
	
	
<link rel="stylesheet" href="/css/allinonecss.min.css">


	
	
	
<link rel="alternate" href="/atom.xml" title="庄菲什" type="application/atom+xml">
</head>
<body class="post-template">
	<div class="site-wrapper">
		




<header class="site-header post-site-header outer">
    <div class="inner">
        
<nav class="site-nav"> 
    <div class="site-nav-left">
        <ul class="nav">
            <li>
                
                <a href="/" title="Home">HOME</a>
                
            </li>
            
        </ul> 
    </div>
     
    <div class="site-nav-right">
         
        
<div class="social-links" >
    
    
    
    
    
    
    
</div>
    </div>
</nav>
    </div>
</header>


<div id="site-main" class="site-main outer" role="main">
    <div class="inner">
        <header class="post-full-header">
            <div class="post-full-meta">
                <time  class="post-full-meta-date" datetime="2020-02-15T00:00:00.000Z">
                    2020-02-15
                </time>
                
                <span class="date-divider">/</span>
                
                
            </div>
            <h1 class="post-full-title">Home Assistant 系列——DIY 篇（上）</h1>
        </header>
        <div class="post-full no-image">
            
            <div class="post-full-content">
                <article id="photoswipe" class="markdown-body">
                    <p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic2@master/uPic/ha3_cover.png" alt="ha3_cover"></p>
<p>Home Assistant 有很多工具可以方便我们 DIY，其中一个是 <a href="https://esphome.io" target="_blank" rel="noopener">ESPHome</a>，以下是小弟的一些尝试：</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="安装-ESPHome"><a href="#安装-ESPHome" class="headerlink" title="安装 ESPHome"></a>安装 ESPHome</h3><p>方法一：在 macOS 安装</p>
<p>首先安装 ESPHome，打开系统终端机，输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install esphome</span><br></pre></td></tr></table></figure>

<p>之后安装 ESPHome 面板，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install tornado esptool</span><br><span class="line">esphome config&#x2F; dashboard</span><br></pre></td></tr></table></figure>

<p>在浏览器访问地址 <code>localhost:6052</code></p>
<p>方法二：在群晖 Docker 安装</p>
<p>在群晖 Docker 安装 ESPHome，之后通过 <a href="https://github.com/marcelstoer/nodemcu-pyflasher/releases" target="_blank" rel="noopener">NodeMCU PyFlasher</a> 刷入固件。</p>
<h3 id="搭建-MQTT-服务器"><a href="#搭建-MQTT-服务器" class="headerlink" title="搭建 MQTT 服务器"></a>搭建 MQTT 服务器</h3><p>打开群晖 Docker，在「注册表」标签中搜索「mqtt」，下载映像，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/ha3_mqtt1.png" alt="mqtt1"></p>
<p>在「映像」标签中找到下载的映像，点击「启动」，在「卷」中添加以下路径 <code>/mosquito/log</code>、<code>/mosquito/data</code>、<code>/mosquito/config</code>，且在<code>/mosquito/config</code> 路径下建立<code>mosquitto.conf</code> 文件，内容可以为空，或参考<a href="https://blog.csdn.net/luckykapok918/article/details/84954017" target="_blank" rel="noopener">这里</a>配置。网络可以选择与宿主机一致或根据自己偏好调整。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/ha3_mqtt2.png" alt="mqtt2"></p>
<p>之后启动 Docker。访问 <code>http://群晖 IP:6052</code> 即可管理 ESPHome，在 Home Home Assistant 的 configuration.yaml 文件，添加以下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mqtt:</span><br><span class="line">  broker: 群晖 IP</span><br><span class="line">  port: 1883</span><br></pre></td></tr></table></figure>

<h2 id="小米墨水屏温度计"><a href="#小米墨水屏温度计" class="headerlink" title="小米墨水屏温度计"></a>小米墨水屏温度计</h2><p><img src="https://esphome.io/_images/xiaomi_lywsd02-full.png" alt=""></p>
<p><img src="https://esphome.io/_images/xiaomi_cgg1-full.jpg" alt=""></p>
<p>小米有出两款墨水屏的温度计，墨水屏比 LCD 屏幕更加清晰，可以利用 ESP32 通过 ESPHome 接入 Home Assistant。</p>
<h3 id="圆形温度计"><a href="#圆形温度计" class="headerlink" title="圆形温度计"></a>圆形温度计</h3><p>参考<a href="https://esphome.io/components/sensor/xiaomi_cgg1.html" target="_blank" rel="noopener">这里</a>接入，访问 <code>ESPHome IP:6052</code>，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/ha3_esphome1.png" alt="ha3_esphome1"></p>
<p>点击「＋」，填入名称、类型选「NodeMCU-32S」、WiFi信息，ESPHome 会帮我们增加一个设备，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/ha3_esphome2.png" alt="ha3_esphome2"></p>
<p>点击「编辑」，加入以下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Example configuration entry</span><br><span class="line">esp32_ble_tracker:</span><br><span class="line"></span><br><span class="line">sensor:</span><br><span class="line">  - platform: xiaomi_cgg1</span><br><span class="line">    mac_address: 7A:80:8E:19:36:BA</span><br><span class="line">    temperature:</span><br><span class="line">      name: &quot;Xiaomi CGG1 Temperature&quot;</span><br><span class="line">    humidity:</span><br><span class="line">      name: &quot;Xiaomi CGG1 Humidity&quot;</span><br><span class="line">    battery_level:</span><br><span class="line">      name: &quot;Xiaomi CGG1 Battery Level&quot;</span><br></pre></td></tr></table></figure>

<p>MAC 地址可由米家 App 获得，之后点击保存、上传刷入固件，Home Assistant 可以自动发现。</p>
<h3 id="长方形温度计"><a href="#长方形温度计" class="headerlink" title="长方形温度计"></a>长方形温度计</h3><p>参考<a href="https://esphome.io/components/sensor/xiaomi_lywsd02.html" target="_blank" rel="noopener">这里</a>接入，加入以下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">esp32_ble_tracker:</span><br><span class="line"></span><br><span class="line">sensor:</span><br><span class="line">  - platform: xiaomi_lywsd02</span><br><span class="line">    mac_address: 3F:5B:7D:82:58:4E</span><br><span class="line">    temperature:</span><br><span class="line">      name: &quot;Xiaomi LYWSD02 Temperature&quot;</span><br><span class="line">    humidity:</span><br><span class="line">      name: &quot;Xiaomi LYWSD02 Humidity&quot;</span><br></pre></td></tr></table></figure>

<h2 id="门禁改造"><a href="#门禁改造" class="headerlink" title="门禁改造"></a>门禁改造</h2><p>参考这个大大的<a href="https://mp.weixin.qq.com/s/10tm0XzSvAlUTu-l8rDhSg" target="_blank" rel="noopener">文章</a>，小弟的门禁比大大的简单，不需要先摘机，可以直接按下开关，所以只需要引出一条线即可，接入继电器，继电器正负极分别接入 NodeMCU 的 3V、G，in 接入 D7，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/ha3_doorbell.png" alt="ha3_doorbell"></p>
<p>在 ESPHome 中加入以下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">switch:</span><br><span class="line">  - platform: gpio</span><br><span class="line">    pin: D7</span><br><span class="line">    id: relay</span><br><span class="line">  - platform: template</span><br><span class="line">    name: &quot;Doorbell&quot;</span><br><span class="line">    turn_on_action:</span><br><span class="line">    - switch.turn_on: relay</span><br><span class="line">    - delay: 500ms</span><br><span class="line">    - switch.turn_off: relay</span><br></pre></td></tr></table></figure>

<p>这里设置了打开 500ms，自动关闭，模拟按下的弹簧弹起。</p>
<h2 id="各种传感器"><a href="#各种传感器" class="headerlink" title="各种传感器"></a>各种传感器</h2><p>ESPHome 接入各种传感器很方便，如温度传感器、光照传感器、手势传感器等等。</p>

                </article>
                <ul class="tags-postTags">
                    
                    <li>
                        <a href="/tags/Home-Assistant/" rel="tag"># Home Assistant</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </div>

    
    <nav id="gobottom" class="pagination">
        
        <a class="prev-post" title="Sketch 使用小贴士" href="/sketch/">
            ← Sketch 使用小贴士
        </a>
        
        <span class="prev-next-post">·</span>
        
        <a class="next-post" title="Home Assistant 系列——设备接入篇" href="/ha2/">
            Home Assistant 系列——设备接入篇 →
        </a>
        
    </nav>

    
</div>






	</div>
	


	




<footer class="site-footer outer">
	<div class="site-footer-content inner">
		<div class="copyright">
			<a href="/" title="庄菲什">庄菲什 &copy; 2022</a>
			
				
    		
		</div>
		<nav class="site-footer-nav">
			
			<a href="https://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
			<a href="https://github.com/xzhih/hexo-theme-casper" title="Casper" target="_blank" rel="noopener">Casper</a>
		</nav>
	</div>
</footer>
	


<script>
    if(window.navigator && navigator.serviceWorker) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                registration.unregister()
            }
        })
    }
</script>


<script id="scriptLoad" src="/js/allinone.min.js" async></script>


<script>
    document.getElementById('scriptLoad').addEventListener('load', function () {
        
        

        
        

        
        
    })
</script>










</body>
</html>
