<!DOCTYPE html>
<html lang="zh-CN">







<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<link rel="preconnect" href="//www.googletagmanager.com">
	<link rel="preconnect" href="//zz.bdstatic.com">
	<link rel="preconnect" href="//sp0.baidu.com">
	<link rel="preconnect" href="//www.google-analytics.com">
	<link rel="preconnect" href="//cdn1.lncld.net">
	<link rel="preconnect" href="//unpkg.com">
	<link rel="preconnect" href="//app-router.leancloud.cn">
	<link rel="preconnect" href="//9qpuwspm.api.lncld.net">
	<link rel="preconnect" href="//gravatar.loli.net">

	<title>洗衣完成发送短信 | 庄菲什</title>

	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
	<meta name="generator" content="hexo">
	<meta name="author" content="drunkfish">
	<meta name="description" content="">

	

	

	

	

	

	<meta property="og:site_name" content="庄菲什">
	<meta property="og:type" content="article">
	<meta property="og:title" content="洗衣完成发送短信 | 庄菲什">
	<meta property="og:description" content="">
	<meta property="og:url" content="http://yoursite.com/ha_washer/">

	
	<meta property="article:published_time" content="2020-11-30T00:11:00+08:00"/> 
	<meta property="article:author" content="drunkfish">
	<meta property="article:published_first" content="庄菲什, /ha_washer/" />
	

	
	
	
<link rel="stylesheet" href="/css/allinonecss.min.css">


	
	
	
<link rel="alternate" href="/atom.xml" title="庄菲什" type="application/atom+xml">
</head>
<body class="post-template">
	<div class="site-wrapper">
		




<header class="site-header post-site-header outer">
    <div class="inner">
        
<nav class="site-nav"> 
    <div class="site-nav-left">
        <ul class="nav">
            <li>
                
                <a href="/" title="Home">HOME</a>
                
            </li>
            
        </ul> 
    </div>
     
    <div class="site-nav-right">
         
        
<div class="social-links" >
    
    
    
    
    
    
    
</div>
    </div>
</nav>
    </div>
</header>


<div id="site-main" class="site-main outer" role="main">
    <div class="inner">
        <header class="post-full-header">
            <div class="post-full-meta">
                <time  class="post-full-meta-date" datetime="2020-11-30T00:00:00.000Z">
                    2020-11-30
                </time>
                
                <span class="date-divider">/</span>
                
                
            </div>
            <h1 class="post-full-title">洗衣完成发送短信</h1>
        </header>
        <div class="post-full no-image">
            
            <div class="post-full-content">
                <article id="photoswipe" class="markdown-body">
                    <p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_washer_cover.png" alt="ha_washer_cover"></p>
<p>小弟看到有大大有贴<a href="https://blog.yxwang.me/2019/07/washer-dryer-notification/" target="_blank" rel="noopener">洗衣机洗衣完成发通知的自动化</a>，通过插座功率的改变来判断洗衣完成，小弟偏好这种接外挂式的改造，感觉实用，跟着试了一番：</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="接入插座"><a href="#接入插座" class="headerlink" title="接入插座"></a>接入插座</h3><p>这个自动化需要一个可以测功率的插座，小弟有一个「小米插座增强版」，有内置测功率的功能，首先要先将这个插座接入 Home Assistant，具体步骤可参考<a href="https://github.com/syssi/xiaomiplug" target="_blank" rel="noopener">这个大大的程序</a>，其中 token 可以通过<a href="https://www.kapiba.ru/2017/11/mi-home.html" target="_blank" rel="noopener">修改版米家 App</a>（仅支持 Android 系统，免 root）获取。</p>
<p>之后在 <code>configuration.yaml</code> 文件中添加一个传感器获取插座功率：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sensor:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">platform:</span> <span class="string">template</span></span><br><span class="line">    <span class="attr">sensors:</span></span><br><span class="line">      <span class="attr">xiaomi_plug_power:</span></span><br><span class="line">        <span class="attr">friendly_name:</span> <span class="string">"socket load power"</span></span><br><span class="line">        <span class="attr">unit_of_measurement:</span> <span class="string">W</span></span><br><span class="line">        <span class="attr">value_template:</span> <span class="string">"<span class="template-variable">&#123;&#123; state_attr('switch.xiaomi_chuangmi_plug_v3', 'load_power') &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure>

<h3 id="配置通知"><a href="#配置通知" class="headerlink" title="配置通知"></a>配置通知</h3><p>Home Assistant 通知方式很多，App 通知无需配置，另外还可以选短信通知、TTS 通知等。</p>
<h3 id="配置-Twilio-短信通知"><a href="#配置-Twilio-短信通知" class="headerlink" title="配置 Twilio 短信通知"></a>配置 Twilio 短信通知</h3><p>利用 Twilio 可以发送短信通知，注册试用即送 $15，美国手机号文字短信 $0.0075/条，中国手机号文字短信 $0.0280/条。</p>
<p>首先到 <a href="https://www.twilio.com" target="_blank" rel="noopener">Twilio</a> 网站注册并试用，验证手机号后可以获得一个美国手机号，账号 SID 及Token。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_washer_twillo.png" alt="ha_washer_twillo"></p>
<p>在 Home Assistant 的 <code>configuration.yaml</code> 文件中添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">twilio:</span></span><br><span class="line">  <span class="attr">account_sid:</span> <span class="string">ACCOUNT_SID_FROM_TWILIO</span></span><br><span class="line">  <span class="attr">auth_token:</span> <span class="string">AUTH_TOKEN_FROM_TWILIO</span></span><br></pre></td></tr></table></figure>

<p>试用账号只能给白名单的手机号，需要将接受短信的手机号添加至白名单，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_washer_twillo_phone.png" alt="ha_washer_twillo_phone"></p>
<h3 id="配置-TTS-通知"><a href="#配置-TTS-通知" class="headerlink" title="配置 TTS 通知"></a>配置 TTS 通知</h3><p>若使用 Googlecast 设备访问地址是配置了 SSL 证书，需要添加 base_url，另外，建议添加与文字内容相同的语言（避免用说英文的方式说中文）。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">platform:</span> <span class="string">google_translate</span></span><br><span class="line">    <span class="attr">base_url:</span> <span class="string">https://&lt;Home</span> <span class="string">Assistant</span> <span class="string">URL&gt;:8123</span></span><br><span class="line">    <span class="attr">language:</span> <span class="string">'en-us'</span></span><br></pre></td></tr></table></figure>

<h3 id="配置-Home-Assistant-应用通知"><a href="#配置-Home-Assistant-应用通知" class="headerlink" title="配置 Home Assistant 应用通知"></a>配置 Home Assistant 应用通知</h3><p>免配置，装好应用，允许应用通知权限即可。</p>
<h2 id="自动化"><a href="#自动化" class="headerlink" title="自动化"></a>自动化</h2><p>自动化这里小弟搬运<a href="https://blog.yxwang.me/2019/07/washer-dryer-notification/" target="_blank" rel="noopener">大大的配置</a>，用两种状态（空闲和运转）描述洗衣机状态，在 <code>configuration.yaml</code> 文件中添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">input_select:</span></span><br><span class="line">  <span class="attr">washer_status:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Washer</span> <span class="string">Status</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Idle</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Running</span></span><br><span class="line">    <span class="attr">initial:</span> <span class="string">Idle</span></span><br></pre></td></tr></table></figure>

<p>定义虚拟的洗衣机传感器，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sensor:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">platform:</span> <span class="string">template</span></span><br><span class="line">    <span class="attr">sensors:</span></span><br><span class="line">      <span class="attr">washer_status:</span></span><br><span class="line">        <span class="attr">value_template:</span> <span class="string">'<span class="template-variable">&#123;&#123; states.input_select.washer_status.state&#125;&#125;</span>'</span></span><br><span class="line">        <span class="attr">friendly_name:</span> <span class="string">'Washer Status'</span></span><br></pre></td></tr></table></figure>

<p>自动化脚本一：检测到电量后的更新洗衣机状态为运转，10 瓦作为运转开始的阈值。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alias:</span> <span class="string">Set</span> <span class="string">washer</span> <span class="string">active</span> <span class="string">when</span> <span class="string">power</span> <span class="string">detected</span></span><br><span class="line"><span class="attr">trigger:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">platform:</span> <span class="string">numeric_state</span></span><br><span class="line">    <span class="attr">entity_id:</span> <span class="string">switch.xiaomi_chuangmi_plug_v3</span></span><br><span class="line">    <span class="attr">value_template:</span> <span class="string">'<span class="template-variable">&#123;&#123; state_attr(''switch.xiaomi_chuangmi_plug_v3'', ''load_power'') &#125;&#125;</span>'</span></span><br><span class="line">    <span class="attr">above:</span> <span class="string">'10'</span></span><br><span class="line"><span class="attr">condition:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">condition:</span> <span class="string">or</span></span><br><span class="line">    <span class="attr">conditions:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">condition:</span> <span class="string">state</span></span><br><span class="line">        <span class="attr">entity_id:</span> <span class="string">sensor.washer_status</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">Idle</span></span><br><span class="line"><span class="attr">action:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">input_select.select_option</span></span><br><span class="line">    <span class="attr">data:</span></span><br><span class="line">      <span class="attr">entity_id:</span> <span class="string">input_select.washer_status</span></span><br><span class="line">      <span class="attr">option:</span> <span class="string">Running</span></span><br><span class="line"><span class="attr">mode:</span> <span class="string">single</span></span><br></pre></td></tr></table></figure>

<p>自动化脚本二：洗衣机用电低于 3 瓦且超过 1 分钟以上后，把状态切换成空置并通过 Twilio 发送短信通知、应用通知、TTS。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alias:</span> <span class="string">Set</span> <span class="string">washer</span> <span class="string">inactive</span></span><br><span class="line"><span class="attr">trigger:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">platform:</span> <span class="string">numeric_state</span></span><br><span class="line">    <span class="attr">entity_id:</span> <span class="string">switch.xiaomi_chuangmi_plug_v3</span></span><br><span class="line">    <span class="attr">value_template:</span> <span class="string">'<span class="template-variable">&#123;&#123; state_attr(''switch.xiaomi_chuangmi_plug_v3'', ''load_power'') &#125;&#125;</span>'</span></span><br><span class="line">    <span class="attr">below:</span> <span class="string">'3'</span></span><br><span class="line">    <span class="attr">for:</span> <span class="string">'0:01:00'</span></span><br><span class="line"><span class="attr">condition:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">condition:</span> <span class="string">or</span></span><br><span class="line">    <span class="attr">conditions:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">condition:</span> <span class="string">state</span></span><br><span class="line">        <span class="attr">entity_id:</span> <span class="string">sensor.washer_status</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">Running</span></span><br><span class="line"><span class="attr">action:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">input_select.select_option</span></span><br><span class="line">    <span class="attr">data:</span></span><br><span class="line">      <span class="attr">entity_id:</span> <span class="string">input_select.washer_status</span></span><br><span class="line">      <span class="attr">option:</span> <span class="string">Idle</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">notify.sms</span></span><br><span class="line">    <span class="attr">data:</span></span><br><span class="line">      <span class="attr">message:</span> <span class="string">'The Washer is finished!'</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">'+8613012345678'</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">'+8613033333333'</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">tts.google_translate_say</span></span><br><span class="line">    <span class="attr">data:</span></span><br><span class="line">      <span class="attr">message:</span> <span class="string">'The Washer is finished!'</span></span><br><span class="line">    <span class="attr">entity_id:</span> <span class="string">media_player.bedroom_speaker</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">notify.notify</span></span><br><span class="line">    <span class="attr">data:</span></span><br><span class="line">      <span class="attr">title:</span> <span class="string">The</span> <span class="string">Washer</span> <span class="string">is</span> <span class="string">finished</span></span><br><span class="line">      <span class="attr">message:</span> <span class="string">'The Washer is finished!'</span> </span><br><span class="line"><span class="attr">mode:</span> <span class="string">single</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_washer_notify.png" alt="ha_washer_notify"></p>

                </article>
                <ul class="tags-postTags">
                    
                    <li>
                        <a href="/tags/Home-Assistant/" rel="tag"># Home Assistant</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </div>

    
    <nav id="gobottom" class="pagination">
        
        <a class="prev-post" title="通过 Calibre-Web 制作图书在线管理" href="/calibre/">
            ← 通过 Calibre-Web 制作图书在线管理
        </a>
        
        <span class="prev-next-post">·</span>
        
        <a class="next-post" title="窗帘快速接入 HA——免去换轨 超快接入" href="/ha_curtain/">
            窗帘快速接入 HA——免去换轨 超快接入 →
        </a>
        
    </nav>

    
</div>






	</div>
	


	




<footer class="site-footer outer">
	<div class="site-footer-content inner">
		<div class="copyright">
			<a href="/" title="庄菲什">庄菲什 &copy; 2022</a>
			
				
    		
		</div>
		<nav class="site-footer-nav">
			
			<a href="https://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
			<a href="https://github.com/xzhih/hexo-theme-casper" title="Casper" target="_blank" rel="noopener">Casper</a>
		</nav>
	</div>
</footer>
	


<script>
    if(window.navigator && navigator.serviceWorker) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                registration.unregister()
            }
        })
    }
</script>


<script id="scriptLoad" src="/js/allinone.min.js" async></script>


<script>
    document.getElementById('scriptLoad').addEventListener('load', function () {
        
        

        
        

        
        
    })
</script>










</body>
</html>
