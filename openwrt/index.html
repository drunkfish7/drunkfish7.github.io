<!DOCTYPE html>
<html lang="zh-CN">







<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<link rel="preconnect" href="//www.googletagmanager.com">
	<link rel="preconnect" href="//zz.bdstatic.com">
	<link rel="preconnect" href="//sp0.baidu.com">
	<link rel="preconnect" href="//www.google-analytics.com">
	<link rel="preconnect" href="//cdn1.lncld.net">
	<link rel="preconnect" href="//unpkg.com">
	<link rel="preconnect" href="//app-router.leancloud.cn">
	<link rel="preconnect" href="//9qpuwspm.api.lncld.net">
	<link rel="preconnect" href="//gravatar.loli.net">

	<title>群晖虚拟机安装软路由 | 庄菲什</title>

	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
	<meta name="generator" content="hexo">
	<meta name="author" content="drunkfish">
	<meta name="description" content="">

	

	

	

	

	

	<meta property="og:site_name" content="庄菲什">
	<meta property="og:type" content="article">
	<meta property="og:title" content="群晖虚拟机安装软路由 | 庄菲什">
	<meta property="og:description" content="">
	<meta property="og:url" content="http://yoursite.com/openwrt/">

	
	<meta property="article:published_time" content="2020-02-01T00:02:00+08:00"/> 
	<meta property="article:author" content="drunkfish">
	<meta property="article:published_first" content="庄菲什, /openwrt/" />
	

	
	
	
<link rel="stylesheet" href="/css/allinonecss.min.css">


	
	
	
<link rel="alternate" href="/atom.xml" title="庄菲什" type="application/atom+xml">
</head>
<body class="post-template">
	<div class="site-wrapper">
		




<header class="site-header post-site-header outer">
    <div class="inner">
        
<nav class="site-nav"> 
    <div class="site-nav-left">
        <ul class="nav">
            <li>
                
                <a href="/" title="Home">HOME</a>
                
            </li>
            
        </ul> 
    </div>
     
    <div class="site-nav-right">
         
        
<div class="social-links" >
    
    
    
    
    
    
    
</div>
    </div>
</nav>
    </div>
</header>


<div id="site-main" class="site-main outer" role="main">
    <div class="inner">
        <header class="post-full-header">
            <div class="post-full-meta">
                <time  class="post-full-meta-date" datetime="2020-02-01T00:00:00.000Z">
                    2020-02-1
                </time>
                
                <span class="date-divider">/</span>
                
                
            </div>
            <h1 class="post-full-title">群晖虚拟机安装软路由</h1>
        </header>
        <div class="post-full no-image">
            
            <div class="post-full-content">
                <article id="photoswipe" class="markdown-body">
                    <p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt_cover.png" alt="openwrt_cover"></p>
<blockquote>
<p>我外表是胖，但内在的我是瘦的。你有没有想到过每个胖人的内部都有个瘦人，就像有人所说，每块石头里都有座雕像？</p>
</blockquote>
<p>软路由是一台运行 <a href="https://openwrt.org/" target="_blank" rel="noopener">OpenWrt</a> 系统的主机，以软件的形式实现拨号、DHCP 等路由器功能。相较于「硬路由」，使用软路由的主要理由有：</p>
<p>1、可以更快更稳地科学上网，因为一个只处理网络相关的 Linux（OpenWrt 基于 Linux） 处理需要消耗 CPU 的运算（如科学上网中的加密解密过程）比其他设备做得更好。</p>
<p>2、有些设备需要科学上网的环境才能正常使用，如 Google Home，Android TV 等等。</p>
<p>这篇文章是群晖虚拟机运行 OpenWrt 作为主路由的步骤，这样做的好处是免去另外增添额外硬件。如果群晖只有一个网口，OpenWrt 只能以「旁路由」的方式运行，想以主路由的方式运行，建议群晖有两个物理网口。</p>
<h2 id="网络连接建议"><a href="#网络连接建议" class="headerlink" title="网络连接建议"></a>网络连接建议</h2><p>大多数光猫默认负责拨号，小弟建议改成桥接模式，不同光猫设置方法不尽相同，可以自行搜索方法，如果搞不定，可以像小弟一样到淘宝寻求办法。</p>
<p>建议软路由做主路由，硬理由以无线 AP 的模式运行，这样的好处是少了一层 NAT ，减少网络损耗，具体网络连接方式如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt1.png" alt="openwrt1"></p>
<h2 id="建立虚拟机"><a href="#建立虚拟机" class="headerlink" title="建立虚拟机"></a>建立虚拟机</h2><p>首先准备好软路由固件，固件可以自己编译（推荐用 Github Actions 编译），也可以使用别人编译好的固件。编译好的固件可以到<a href="https://www.right.com.cn/forum/forum-169-1.html" target="_blank" rel="noopener">恩山论坛 x86 系统区</a>去找，有很多大大编译好的，比如小弟使用的<a href="https://www.right.com.cn/forum/thread-3708606-1-1.html" target="_blank" rel="noopener">这个</a>。</p>
<p>注意：固件文件一般会有 combined 和 uefi-gpt 两种，前者支持 MBR 的分区表和 BIOS 系统，后者支持 GPT 分区表和 EFI 系统。我们这里选用 uefi-gpt 即可，下载的固件后缀名为「.gz」，需要解压成「.img」文件。</p>
<p>打开群晖「套件中心」，搜索「Virtual Machine Manager」，下载并安装，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt2.png" alt="openwrt2"></p>
<p>打开 Virtual Machine Manager，在「网络」中添加两个网口，一个作为软路由 LAN 口（作为 DHCP 的网口），一个作为 WAN 口（连外网的网口），</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt3.png" alt="openwrt3"></p>
<p>最终添加两个网口，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt4.png" alt="openwrt4"></p>
<p>在「映像」中选择「创建」，选择「从电脑上传」，上传后缀为「.img」的固件文件，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt5.png" alt="openwrt5"></p>
<p>在「虚拟机」中选择「新建」→「导入」，选择刚刚的映像，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt7.png" alt="openwrt7"></p>
<p>填入虚拟机名称，名字任意，如 openwrt，选择 CPU、内存（建议 1G 或以上）配置，点击「下一步」，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt8.png" alt="openwrt8"></p>
<p>选择硬盘容量，最小是 10G，点击「下一步」，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt9.png" alt="openwrt9"></p>
<p>点击「+」新增网口，注意 LAN（作为 DHCP 的网口）在上， WAN（连外网的网口）在下，点击「下一步」，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt10.png" alt="openwrt10"></p>
<p>建议勾选「开机自启动」，点击「下一步」，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt11.png" alt="openwrt11"></p>
<p>权限可以全部勾选，点击「下一步」，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt12.png" alt="openwrt12"></p>
<p>确认配置，点击「完成」。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt13.png" alt="openwrt13"></p>
<h2 id="联网设置"><a href="#联网设置" class="headerlink" title="联网设置"></a>联网设置</h2><h3 id="配置网口"><a href="#配置网口" class="headerlink" title="配置网口"></a>配置网口</h3><p>OpenWrt 模拟了一个管理地址 192.168.1.1 ，可能与我们的路由器或光猫冲突，我们需要先调整管理界面地址。</p>
<p>在「虚拟机」标签卡中找到刚刚建立的虚拟机，若未开机可以先开机，点击「连接」，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt14.png" alt="openwrt14"></p>
<p>在新浏览器标签页可以看到 OpenWrt 运行的命令行，点击回车，看到 OpenWrt 的标志，之后输入<code>vi /etc/config/network</code>，点击回车，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt15.png" alt="openwrt15"></p>
<p>之后输入<code>i</code>，进入编辑模式，找到「lan」，将地址改为其他未占用的 IP，如<code>192.168.77.1</code>，之后按 esc 键退出编辑模式，之后重启虚拟机。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt16.png" alt="openwrt16"></p>
<p>下一步将硬路由设置为 AP 模式，不同路由器设置方法不一样，若是华硕路由器可以下载 <a href="https://www.asus.com/asus-router-app/" target="_blank" rel="noopener">ASUS Router</a> 这个 App 将路由器改为 AP 模式，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt17_new.png" alt="openwrt17"></p>
<p>先将群晖关机，将一根网线一端插入  LAN 口（作为 DHCP 的网口），另一端插入路由器，之后将群晖开机，</p>
<p>电脑连接路由器的 WiFi，访问刚刚设定的 OpenWrt 的管理地址，如<code>192.168.77.1</code>，输入密码（可以在固件介绍页找到），找到「网络」→「接口」，在 WAN 口点击「修改」，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt18_new.png" alt="openwrt18"></p>
<p>设置连外网方式，如选择「PPPoE」，填入宽带账号、密码，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt19_new.png" alt="openwrt19"></p>
<p>稍等片刻，应该可以联网了。</p>
<h3 id="科学上网设置"><a href="#科学上网设置" class="headerlink" title="科学上网设置"></a>科学上网设置</h3><p>OpenWrt 固件一般会内置不止一个科学上网工具，如 ShadowSocksR Plus+、PassWall、Hello World、OpenClash，填入节点信息即可，或者填入订阅地址。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt20_new.png" alt="openwrt20"></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>若群晖无法联网，可以这样修改，在「控制面板」中找到「网络」，在「常规」选项卡中修改网关地址，将 OpenWrt 的管理地址移到上面。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt21_new.png" alt="openwrt21"></p>
<h2 id="软路由设置"><a href="#软路由设置" class="headerlink" title="软路由设置"></a>软路由设置</h2><p>OpenWrt 功能很多，以下是几个常用功能的位置：</p>
<h3 id="设置密码"><a href="#设置密码" class="headerlink" title="设置密码"></a>设置密码</h3><p>在「系统」→「管理权」中可以修改登录密码。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt22.png" alt="openwrt22"></p>
<h3 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h3><p>我们想在外网访问内网的服务或设备，可以使用「端口转发」功能，可以在「网络」→「防火墙」→「端口转发」中找到。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt23_new.png" alt="openwrt23"></p>
<h3 id="DNS-劫持"><a href="#DNS-劫持" class="headerlink" title="DNS 劫持"></a>DNS 劫持</h3><p>需要将特定域名跳转至特定地址，可以使用「DNS 劫持」，可以在「网络」→「主机名」找到。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt24_new.png" alt="openwrt24"></p>
<h2 id="管理-Openwrt"><a href="#管理-Openwrt" class="headerlink" title="管理 Openwrt"></a>管理 Openwrt</h2><h3 id="SSH-连接"><a href="#SSH-连接" class="headerlink" title="SSH 连接"></a>SSH 连接</h3><p>OpenWrt 有内置终端机，在「系统」→「TTYD」可以找到。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt25.png" alt="openwrt25"></p>
<h3 id="STP-管理文件"><a href="#STP-管理文件" class="headerlink" title="STP 管理文件"></a>STP 管理文件</h3><p>在 STP 客户端，如 Transmit 中选择「STP」，填入 OpenWrt IP地址，用户名填「root」，之后就可以管理 OpenWrt 文件。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt27.png" alt="openwrt27"></p>
<h3 id="固件升级"><a href="#固件升级" class="headerlink" title="固件升级"></a>固件升级</h3><p>OpenWrt 支持固件升级，若使用同一个作者编译的，可以保留配置，Web 页面升级 *.gz 文件无需解压，在「系统」→「备份/升级」中上传固件即可。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic@master/uPic/openwrt26_new.png" alt="openwrt26"></p>

                </article>
                <ul class="tags-postTags">
                    
                </ul>
            </div>
        </div>
    </div>

    
    <nav id="gobottom" class="pagination">
        
        <a class="prev-post" title="iOS 应用推荐" href="/ios/">
            ← iOS 应用推荐
        </a>
        
        <span class="prev-next-post">·</span>
        
        <a class="next-post" title="Apple Watch 使用理由" href="/watch/">
            Apple Watch 使用理由 →
        </a>
        
    </nav>

    
</div>






	</div>
	


	




<footer class="site-footer outer">
	<div class="site-footer-content inner">
		<div class="copyright">
			<a href="/" title="庄菲什">庄菲什 &copy; 2022</a>
			
				
    		
		</div>
		<nav class="site-footer-nav">
			
			<a href="https://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
			<a href="https://github.com/xzhih/hexo-theme-casper" title="Casper" target="_blank" rel="noopener">Casper</a>
		</nav>
	</div>
</footer>
	


<script>
    if(window.navigator && navigator.serviceWorker) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                registration.unregister()
            }
        })
    }
</script>


<script id="scriptLoad" src="/js/allinone.min.js" async></script>


<script>
    document.getElementById('scriptLoad').addEventListener('load', function () {
        
        

        
        

        
        
    })
</script>










</body>
</html>
