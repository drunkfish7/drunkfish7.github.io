<!DOCTYPE html>
<html lang="zh-CN">







<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<link rel="preconnect" href="//www.googletagmanager.com">
	<link rel="preconnect" href="//zz.bdstatic.com">
	<link rel="preconnect" href="//sp0.baidu.com">
	<link rel="preconnect" href="//www.google-analytics.com">
	<link rel="preconnect" href="//cdn1.lncld.net">
	<link rel="preconnect" href="//unpkg.com">
	<link rel="preconnect" href="//app-router.leancloud.cn">
	<link rel="preconnect" href="//9qpuwspm.api.lncld.net">
	<link rel="preconnect" href="//gravatar.loli.net">

	<title>Google Assistant 接入 HA | 庄菲什</title>

	<meta name="HandheldFriendly" content="True" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
	<meta name="generator" content="hexo">
	<meta name="author" content="drunkfish">
	<meta name="description" content="">

	

	

	

	

	

	<meta property="og:site_name" content="庄菲什">
	<meta property="og:type" content="article">
	<meta property="og:title" content="Google Assistant 接入 HA | 庄菲什">
	<meta property="og:description" content="">
	<meta property="og:url" content="http://yoursite.com/ha_ga/">

	
	<meta property="article:published_time" content="2020-11-01T00:11:00+08:00"/> 
	<meta property="article:author" content="drunkfish">
	<meta property="article:published_first" content="庄菲什, /ha_ga/" />
	

	
	
	
<link rel="stylesheet" href="/css/allinonecss.min.css">


	
	
	
<link rel="alternate" href="/atom.xml" title="庄菲什" type="application/atom+xml">
</head>
<body class="post-template">
	<div class="site-wrapper">
		




<header class="site-header post-site-header outer">
    <div class="inner">
        
<nav class="site-nav"> 
    <div class="site-nav-left">
        <ul class="nav">
            <li>
                
                <a href="/" title="Home">HOME</a>
                
            </li>
            
        </ul> 
    </div>
     
    <div class="site-nav-right">
         
        
<div class="social-links" >
    
    
    
    
    
    
    
</div>
    </div>
</nav>
    </div>
</header>


<div id="site-main" class="site-main outer" role="main">
    <div class="inner">
        <header class="post-full-header">
            <div class="post-full-meta">
                <time  class="post-full-meta-date" datetime="2020-11-01T00:00:00.000Z">
                    2020-11-1
                </time>
                
                <span class="date-divider">/</span>
                
                
            </div>
            <h1 class="post-full-title">Google Assistant 接入 HA</h1>
        </header>
        <div class="post-full no-image">
            
            <div class="post-full-content">
                <article id="photoswipe" class="markdown-body">
                    <p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_ga_cover.png" alt="ha_google_assistant_cover"></p>
<p>Google Assistant 接入 Home Assistant 最简单的方法是通过 <a href="https://www.home-assistant.io/cloud/" target="_blank" rel="noopener">Home Assistant Cloud</a> 服务，每月 ＄5，收入用于支持 Home Assistant 的开发，如果不想折腾可以直接订阅即可。另外一种方法是通过手动设置的方法，下面是步骤：</p>
<h2 id="设置好外网访问"><a href="#设置好外网访问" class="headerlink" title="设置好外网访问"></a>设置好外网访问</h2><p>首先确保有公网 IP，在群晖或路由器中设置好 DDNS、端口映射 8123 端口，域名申请好 SSL 证书。</p>
<h2 id="新增-Action"><a href="#新增-Action" class="headerlink" title="新增 Action"></a>新增 Action</h2><p>打开网址 <a href="http://console.actions.google.com/" target="_blank" rel="noopener">http://console.actions.google.com</a>，</p>
<p>点击 <code>New Project</code> 并为项目命名，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_ga1.png" alt="ha_ga1"></p>
<p>选中 <code>Smart Home</code> 卡片，之后点击 <code>Start Building</code>，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_ga2.png" alt="ha_ga2"></p>
<p>点击 <code>Name your Smart Home action</code> 下方 <code>Quick Setup</code> 的名称，为操作命名（Home Assistant 将在 Google Home 应用中显示为 <code>[test] &lt;Action Name&gt;</code>），</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_ga3.png" alt="ha_ga3"></p>
<p>点击 <code>Build your Action</code>下方的 <code>Add Action(s)</code>，添加 Home Assistant 的访问 URL <code>https://[YOUR HOME ASSISTANT URL:PORT]/api/google_assistant</code>，之后点击 <code>Save</code>，在 <code>Overview</code> 选项卡，可以看到应用程序详细信息。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_ga4.png" alt="ha_ga4"></p>
<h2 id="关联账号"><a href="#关联账号" class="headerlink" title="关联账号"></a>关联账号</h2><p>点击页面 <code>Setup account linking</code> 下面的 <code>Quick Setup</code> 设置<code>Overview</code>，</p>
<p>输入以下内容：1.专案项目 ID： <code>https://oauth-redirect.googleusercontent.com/r/YOUR_PROJECT_ID</code>（可以通过网址 URL 看到 YOUR_PROJECT_ID，）；2. Client Secret：无填写要求；3.授权 URL（与实际 URL 替换）： <code>https://[YOUR HOME ASSISTANT URL:PORT]/auth/authorize</code>。4.令牌URL（与实际URL替换）： <code>https://[YOUR HOME ASSISTANT URL:PORT]/auth/token</code>，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_ga5.png" alt="ha_ga5"></p>
<p>在<code>Configure your client</code> <code>Scopes</code>文本框中，输入 <code>email</code> 并点击 <code>Add scope</code>，输入<code>name</code>并再次点击 <code>Add scope</code> 。（不要勾选 <code>Google to transmit clientID and secret via HTTP basic auth header</code>)，点击<code>Next</code>，然后点击 <code>Save</code>，</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_ga6.png" alt="ha_ga6"></p>
<p>选择顶部的选项卡 <code>Test</code> 按钮以生成草稿版本 Test App。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_ga7.png" alt="ha_ga7"></p>
<h2 id="启用设备同步"><a href="#启用设备同步" class="headerlink" title="启用设备同步"></a>启用设备同步</h2><p>这一步的目的是向Google服务器发送状态报告，当使用命令 Ok Google，sync my devices 时，可以同步设备。</p>
<p>首先在GCP控制台中，转到<a href="https://console.cloud.google.com/apis/credentials/serviceaccountkey" target="_blank" rel="noopener">「创建服务帐户密钥」</a>页面。</p>
<p>确保匹配 <code>project_id</code>，从服务帐户列表中，选择新服务帐户。在服务帐户名称字段中，输入名称。在服务帐户 ID 字段中，输入 ID。从角色列表中，选择服务帐户 &gt; 服务帐户令牌创建者。密钥类型，选择 JSON，点击创建，之后包含密钥下载的 JSON 文件将自动下载。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_ga8.png" alt="ha_ga8"></p>
<p>转到 <a href="https://console.cloud.google.com/apis/api/homegraph.googleapis.com/overview" target="_blank" rel="noopener">Google API 控制台</a>。选择项目，查找并启用 HomeGraph API。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_ga9.png" alt="ha_ga9"></p>
<h2 id="Home-Assistant-配置"><a href="#Home-Assistant-配置" class="headerlink" title="Home Assistant 配置"></a>Home Assistant 配置</h2><p>将以下配置添加至 <code>configuration.yaml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">google_assistant:</span></span><br><span class="line">  <span class="attr">project_id:</span> <span class="string">YOUR_PROJECT_ID</span></span><br><span class="line">  <span class="attr">service_account:</span> <span class="type">!include</span> <span class="string">SERVICE_ACCOUNT.JSON</span></span><br><span class="line">  <span class="attr">report_state:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>如果有不想使用 Google Assistant 进行控制的实体，可以将其禁用，在其下方，键入<code>expose:</code>并将其设置为<code>false</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">google_assistant:</span></span><br><span class="line">    <span class="attr">light.living_room:</span></span><br><span class="line">      <span class="attr">expose:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="Google-Home-App-设置"><a href="#Google-Home-App-设置" class="headerlink" title="Google Home App 设置"></a>Google Home App 设置</h2><p>打开手机上的 Google Home App，添加设备，选择 test 账号，之后填入 Home Assistant 用户名及密码。</p>
<p><img src="https://cdn.jsdelivr.net/gh/drunkfish7/pic3@master/uPic/ha_ga10.png" alt="ha_ga10"></p>

                </article>
                <ul class="tags-postTags">
                    
                    <li>
                        <a href="/tags/Home-Assistant/" rel="tag"># Home Assistant</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </div>

    
    <nav id="gobottom" class="pagination">
        
        <a class="prev-post" title="Alexa 接入 HA" href="/ha_alexa/">
            ← Alexa 接入 HA
        </a>
        
        <span class="prev-next-post">·</span>
        
        <a class="next-post" title="制作使用网址导航" href="/nav/">
            制作使用网址导航 →
        </a>
        
    </nav>

    
</div>






	</div>
	


	




<footer class="site-footer outer">
	<div class="site-footer-content inner">
		<div class="copyright">
			<a href="/" title="庄菲什">庄菲什 &copy; 2022</a>
			
				
    		
		</div>
		<nav class="site-footer-nav">
			
			<a href="https://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
			<a href="https://github.com/xzhih/hexo-theme-casper" title="Casper" target="_blank" rel="noopener">Casper</a>
		</nav>
	</div>
</footer>
	


<script>
    if(window.navigator && navigator.serviceWorker) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                registration.unregister()
            }
        })
    }
</script>


<script id="scriptLoad" src="/js/allinone.min.js" async></script>


<script>
    document.getElementById('scriptLoad').addEventListener('load', function () {
        
        

        
        

        
        
    })
</script>










</body>
</html>
